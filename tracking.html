<!DOCTYPE html>
<html lang="en">
<head>
  <title>Pet Tracker WatchDog - Tracking</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Include Bootstrap CSS and other styles --> 
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- Custom styles -->
  <link rel="stylesheet" href="styles.css"> <!-- Custom styles -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
  <!-- Include Font Awesome for icons (if needed) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

  <style>
    /* Existing styles */
    #map {
      height: 400px;
      width: 100%;
    }
    h1 {
      font-family: 'Roboto', sans-serif; 
      font-size: 3rem; 
      font-weight: bold; 
      color: #008080; 
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5); /* horizontal offset, vertical offset, blur radius, color */
    }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="#">Pet Tracker WatchDog</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"       aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
  
    <!-- Navbar links -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto">
        <!-- Update the links as per your website structure -->
        <li class="nav-item">
          <a class="nav-link" href="index.html">Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Tracking</a>
        </li>
        <li class="nav-item active">
          <a class="nav-link" href="features.html">Feature Activation</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="refine_safeArea.html">Refine Safe area</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="about.html">About</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="contacts.html">Contact/Settings</a>
        </li>
      </ul>
    </div>
  </nav>

<!-- Main content -->
<div class="container-fluid main-content">
  <div class="row">
    <div class="col-md-12">
      <div class="w3-row w3-padding-64">
        <div class="w3-container w3-center">
          <h1 class="display-4 text-center">View GPS Tracking / Safe Area</h1>
          <p class="lead text-center">This is the Tracking page. You will be able to view your pet's location as well as create/view safe areas.</p>
        </div>
      </div>

      <input type="text" id="addressInput" class="form-control mb-2" placeholder="Enter address">
      <input type="number" id="radiusInput" class="form-control mb-2" placeholder="Enter radius (in meters)">
      <button onclick="createGeofence()" class="btn btn-primary mb-3">Create Geofence</button>
      <button onclick="createCustomGeofence()" class="btn btn-primary mb-3">Use Refined Safe Area</button>

      <div id="map"></div>
    </div>
  </div>
</div>

<!-- Footer -->
<footer class="footer mt-auto py-3 bg-dark text-white">
  <div class="container text-center">
    <span class="text-muted">Made By Team 34</span>
  </div>
</footer>

<!-- Include Socket.IO client library -->
<script src="/socket.io/socket.io.js"></script>
<!-- Include EmailJS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<script>
  // Initialize EmailJS
  (function(){
      emailjs.init("YOUR_EMAILJS_USER_ID"); // Replace with your EmailJS user ID
  })();

  let map;
  let circle;
  let polygon;
  let trackingMarker;
  let previousInsideGeofence = null;

  // New variables for smooth animation
  let animationInterval;
  const animationDuration = 1000; // Duration of the animation in milliseconds

  function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
      center: { lat: 30.616249, lng: -96.336853 }, // Default center
      zoom: 15
    });

    loadSavedGeofence(); // Load saved geofence when the map is initialized
    startSocketIO(); // Start Socket.IO connection and handling
  }

  function createGeofence() {
    const address = document.getElementById('addressInput').value;
    const radius = parseInt(document.getElementById('radiusInput').value); // Parse radius as an integer
    const geocoder = new google.maps.Geocoder();

    if (polygon) {
      polygon.setMap(null);
      localStorage.removeItem('savedCustomGeofence');
    }

    geocoder.geocode({ address: address }, function (results, status) {
      if (status === 'OK') {
        const location = results[0].geometry.location;

        if (circle) {
          circle.setMap(null); // Remove existing circle from the map
          localStorage.removeItem('savedGeofence'); // Remove saved geofence from localStorage
        }

        circle = new google.maps.Circle({
          strokeColor: '#3CB043',
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: '#74B72E',
          fillOpacity: 0.35,
          map: map,
          center: location,
          radius: radius
        });

        // Fit the map bounds to the circle's bounds
        const circleBounds = circle.getBounds();
        map.fitBounds(circleBounds);

        // Center the map to the circle's center
        map.setCenter(location);

        // Save address and radius to localStorage
        saveGeofence(address, radius);
      } else {
        alert('Geocode was not successful for the following reason: ' + status);
      }
    });
  }

  // Function to load the saved geofence from localStorage
  function loadSavedGeofence() {
    const savedGeofence = JSON.parse(localStorage.getItem('savedGeofence'));
    if (savedGeofence) {
      document.getElementById('addressInput').value = savedGeofence.address;
      document.getElementById('radiusInput').value = savedGeofence.radius;
      createGeofence(); // Recreate the geofence when the page loads
    }
  }

  // Function to save the geofence to localStorage
  function saveGeofence(address, radius) {
    const geofence = { address, radius };
    localStorage.setItem('savedGeofence', JSON.stringify(geofence));
  }

  // Call createGeofence() when Enter key is pressed in address or radius input fields
  document.getElementById('addressInput').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
      createGeofence();
    }
  });

  document.getElementById('radiusInput').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
      createGeofence();
    }
  });

  function startSocketIO() {
    const socket = io(); // Connect to the Socket.IO server

    socket.on('new-coordinate', (data) => {
      updateLocation(data);
    });
  }

  function updateLocation(data) {
    if (data && data.latitude && data.longitude) {
      const gpsLocation = {
        lat: data.latitude,
        lng: data.longitude,
      };

      // If it's the first update, place the marker without animation
      if (!trackingMarker) {
        trackingMarker = new google.maps.Marker({
          position: gpsLocation,
          map: map,
          title: 'GPS Module Location',
          icon: {
            url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png', // Customize the marker icon
          },
        });
      } else {
        // Smoothly animate the marker to the new position
        animateMarker(trackingMarker, gpsLocation);
      }

      // Optionally, center the map to the new location
      // map.panTo(gpsLocation);

      // Check if the location is inside the geofence
      let insideGeofence = false;

      if (polygon) {
        // Check if inside custom polygon geofence
        insideGeofence = google.maps.geometry.poly.containsLocation(
          new google.maps.LatLng(gpsLocation.lat, gpsLocation.lng),
          polygon
        );
      } else if (circle) {
        // Check if inside circular geofence
        insideGeofence =
          google.maps.geometry.spherical.computeDistanceBetween(
            new google.maps.LatLng(gpsLocation.lat, gpsLocation.lng),
            circle.getCenter()
          ) <= circle.getRadius();
      }

      // Check for exit or entry
      if (
        previousInsideGeofence !== null &&
        previousInsideGeofence !== insideGeofence
      ) {
        if (!insideGeofence) {
          alert('GPS Module has exited the geofence!');
          sendMail('exited');
        } else {
          alert('GPS Module has entered the geofence!');
          sendMail('entered');
        }
      }

      previousInsideGeofence = insideGeofence;
    } else {
      console.error('Invalid data received:', data);
    }
  }

  function animateMarker(marker, newPosition) {
    if (animationInterval) {
      clearInterval(animationInterval);
    }

    const startPosition = marker.getPosition();
    const startTime = performance.now();

    animationInterval = setInterval(() => {
      const elapsed = performance.now() - startTime;
      const progress = Math.min(elapsed / animationDuration, 1);

      const lat = startPosition.lat() + (newPosition.lat - startPosition.lat()) * progress;
      const lng = startPosition.lng() + (newPosition.lng - startPosition.lng()) * progress;

      marker.setPosition(new google.maps.LatLng(lat, lng));

      if (progress === 1) {
        clearInterval(animationInterval);
      }
    }, 16); // Approximately 60 frames per second
  }

  // Function to send an email using EmailJS
  function sendMail(status) {
    var serviceID = "YOUR_EMAILJS_SERVICE_ID"; // Replace with your EmailJS service ID
    var templateID = "YOUR_EMAILJS_TEMPLATE_ID"; // Replace with your EmailJS template ID

    var templateParams = {
      status: status, // 'exited' or 'entered'
      // Add other template parameters as needed
    };

    emailjs.send(serviceID, templateID, templateParams)
      .then(res => {
        console.log("Email sent successfully");
      })
      .catch(err => {
        console.error("Error sending email:", err);
      });
  }



  function createCustomGeofence() {
    if (circle) {
      circle.setMap(null); // Remove existing circle from the map
      localStorage.removeItem('savedGeofence'); // Remove saved geofence from localStorage
    }

    if (polygon) {
      polygon.setMap(null);
      localStorage.removeItem('savedCustomGeofence');
    }

    // Create custom geofence
    if (verticesSafeArea.length > 0) {
      const verticesLatLng = verticesSafeArea.map(vertex => ({
        lat: vertex.lat,
        lng: vertex.lng
      }));

      polygon = new google.maps.Polygon({
        paths: verticesLatLng,
        strokeColor: '#3CB043',
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: '#74B72E',
        fillOpacity: 0.35,
      });

      // Set the polygon on the map
      polygon.setMap(map);

      // Calculate the bounds of the polygon
      const polygonBounds = new google.maps.LatLngBounds();
      verticesLatLng.forEach(vertex => {
        polygonBounds.extend(vertex);
      });

      // Fit the map bounds to the polygon's bounds
      map.fitBounds(polygonBounds);

      // Save the custom geofence vertices to local storage
      saveCustomGeofence(verticesSafeArea);
    }
  }

  // Function to save the custom geofence vertices to local storage
  function saveCustomGeofence(vertices) {
    localStorage.setItem('savedCustomGeofence', JSON.stringify(vertices));
  }
</script>

<!-- Include jQuery and Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<!-- Include Popper.js and Bootstrap JS (for Bootstrap features) -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<!-- Include Google Maps API with geometry library -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDabNS8338DeJ3yXMJO5GPZk1cyR3FKOV4&libraries=places&callback=initMap" async defer></script>
</body>
</html>
